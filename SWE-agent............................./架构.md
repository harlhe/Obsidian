sweagent/
├── run/
│   ├── batch_instances.py    # 数据集加载核心
│   └── run_batch.py         # 批处理执行
├── environment/
│   ├── repo.py              # GitHub 仓库管理
│   └── swe_env.py          # 环境管理
├── utils/
│   └── github.py           # GitHub 工具函数
└── agent/
    └── models.py           # 模型相关代码

tests/
├── test_batch_instance.py  # 数据集测试
└── test_env_utils.py       # 环境工具测试

config/
├── default.yaml            # 默认配置
└── benchmarks/            # 评测配置
![[Pasted image 20250806161534.png]]
sys模版初始化
instance模版接收问题描述
接收PR描述（pro-statement）来自github issue
ReAct (Reason and Act) 模式
TDD (Test-Driven Development) 思想的引入

### 核心概念与设计思想 (Core Concepts & Design Philosophy)


1. **ReAct (Reason and Act) 模式**: 这是整个 Agent 的核心工作流程。Agent 不是一次性生成所有代码，而是进行一个“思考 → 行动 → 观察”的循环。
    
    - **Reason (思考)**: 在 `<thinking>` 块中，Agent 分析问题，制定下一步计划。
        
    - **Act (行动)**: Agent 决定调用一个工具（如 `bash` 执行命令，或 `edit` 修改文件）。
        
    - Observe (观察): Agent 接收工具执行后的结果（OBSERVATION），并基于这个新信息开始下一轮的“思考”。
        
        next_step_template 就是用来承载 OBSERVATION 并启动下一轮循环的。
        
2. **TDD (Test-Driven Development) 思想的引入**: Prompt 明确要求 Agent 遵循一个类似 TDD 的工作流：
    
    - **步骤 2: `Create a script to reproduce the error`**: 这相当于 TDD 中的“写一个失败的测试”（Red）。Agent 必须首先证明它能复现问题。
        
    - **步骤 3: `Edit the sourcecode`**: 这是“写代码让测试通过”（Green）。
        
    - 步骤 4: Rerun your reproduce script: 这是“确认测试通过”（Green）。
        
        这个流程极大地提高了 Agent 修复问题的准确性和可靠性。
        
3. **高度结构化与约束化的任务指令**: Prompt 的设计非常巧妙，通过各种指令来约束 Agent 的行为，避免其“自由发挥”导致错误。
    
    - **明确的任务范围**: `DON'T have to modify the testing logic` (无需修改测试文件) 是一个至关重要的约束，它将 Agent 的注意力完全集中在修复核心逻辑上，大大降低了任务的复杂性。
        
    - **最小化变更原则**: `make the minimal changes` 要求 Agent 像一个经验丰富的工程师一样，只做必要的修改，避免不必要的代码重构。
        
    - **固定的工作流程**: 提供的 1-5 步清晰地定义了解决问题的路径，为 Agent 提供了明确的指引。
        
4. **工具集（Tooling）的封装与环境控制**: Agent 的能力并非无限，而是由提供的工具集严格定义的。
    
    - `enable_bash_tool: true`: 赋予 Agent 操作真实计算环境（一个容器化环境）的能力，可以读写文件、执行脚本、安装依赖等。
        
    - `env_variables`: 通过设置环境变量（如 `PAGER: cat`, `PIP_PROGRESS_BAR: 'off'`）来确保工具的输出是干净、非交互式的，便于 Agent 解析。
        
    - `bundles`: 这种设计将相关的工具（如文件编辑、代码审查提交）打包，便于管理和复用。
        

### Prompt 文件结构详解 (File Structure Breakdown)

下面我们逐段解析这个 YAML 文件的具体含义。

#### `agent`

这是 Agent 的核心配置。

- **`templates`**: 定义了与 LLM 交互时使用的不同 Prompt 模板。
    
    - **`system_template`**: 定义 Agent 的顶层角色——“一个可以与计算机交互来解决问题的助手”。这是每次与模型交互时都会发送的系统级指令。
        
    - **`instance_template`**: 这是主任务模板，用于启动整个问题解决流程。
        
        - `<uploaded_files>`: 占位符，用于注入工作目录的文件结构信息（`filemap`），让 Agent 了解项目概览。
            
        - `<pr_description>`: 占位符，用于注入具体的问题描述（通常来自 GitHub Issue）。
            
        - **核心指令**: 明确告知 Agent 它的任务是根据 `<pr_description>` 修改代码，并强调**不要修改测试文件**，且变更要**最小化**。
            
        - **5步工作流**: 提供了明确的解决步骤，引导 Agent 采用 TDD 式的开发流程。
            
    - **`next_step_template`**: 定义了在 Agent 执行完一个动作并得到观察结果（`{{observation}}`）后，如何将这个结果呈现给 Agent 以便其进行下一步思考。
        
    - **`next_step_no_output_template`**: 是 `next_step_template` 的一个变体，用于处理那些成功执行但没有任何标准输出的命令。
        
- **`tools`**: 定义了 Agent 可以使用的工具和相关配置。
    
    - `env_variables`: 为 Agent 的 `bash` 环境预设环境变量，以确保输出的确定性和简洁性。
        
    - `bundles`: 加载预定义的工具包，例如文件操作、代码审查等。
        
    - `registry_variables`: 为工具提供配置参数。
        
        - `USE_FILEMAP: 'true'`: 确认启用文件映射功能，让 Agent 能“看到”整个代码结构。
            
        - `SUBMIT_REVIEW_MESSAGES`: 这是一个非常精巧的设计。它预定义了一个在任务完成并提交时使用的消息模板。这个模板会指导人类或其他系统如何审查 Agent 的工作，例如要求重新运行验证脚本、移除脚本、还原测试文件等，确保了交付质量。`{{diff}}` 会被替换为 Agent 的具体代码修改。
            
    - `enable_bash_tool: true`: 明确启用 `bash` 工具，这是 Agent 与文件系统和操作系统交互的主要手段。
        
    - `parse_function`: 指定解析模型输出的方式为 `function_calling`，意味着模型会被训练成输出结构化的函数调用指令，而不是纯文本。
        
- **`history_processors`**: 定义如何处理对话历史。
    
    - `cache_control`: `last_n_messages: 2` 表示为了节省 Token 和保持上下文的焦点，每次只保留最近的两次交互（通常是上一步的思考/行动和观察结果）在历史记录中。
        
- **`model`**:
    
    - `name: claude-sonnet-4-20250514`: 明确指定了使用的 LLM 型号及其版本。使用带日期的版本号有助于保证实验的可复现性。
        

#### `env` (Environment)

定义了 Agent 工作环境的上下文。

- **`repo`**: 指定了目标代码仓库的 GitHub 地址。
    

#### `deployment`

定义了运行 Agent 的容器化环境配置。

- `image: tiny`: 使用一个轻量级的 `tiny` 镜像作为基础运行环境。
    
- `python_standalone_dir: ""`: Python 相关路径配置。
    

#### `problem_statement`

定义了任务来源。

- `github_url`: 指定了包含问题描述的 GitHub Issue 的 URL。框架会自动从这个 URL 抓取问题描述并填充到 `{{problem_statement}}` 占位符中。
    

### 总结

这是一个设计精良、高度工程化的 AI Agent 配置文件。它不依赖于模型一次性的“灵光一闪”，而是通过**清晰的角色定义、严格的流程约束、强大的工具集和类似 TDD 的验证闭环**，将复杂的软件工程任务分解为一系列 Agent 可以稳定执行的步骤，从而系统性地提升了 AI 解决实际代码问题的成功率和可靠性。
